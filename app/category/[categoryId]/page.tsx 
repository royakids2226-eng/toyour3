"use client";

import { useState, useEffect } from "react";
import Header from "../../components/Header";
import ProductCard from "../../components/ProductCard";

interface Product {
  modelId: string;
  price: number;
  category: string;
  description: string;
  group_name?: string;
  kind_name?: string;
  item_name?: string;
  master_code?: string;
  variants: Array<{
    id: string;
    color: string;
    imageUrl: string;
    sizes: string[];
  }>;
}

interface Category {
  id: number;
  name: string;
  image: string;
}

export default function CategoryDetailPage({
  params,
}: {
  params: { id: string };
}) {
  const [products, setProducts] = useState<Product[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [categoryProducts, setCategoryProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù€ API
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        const response = await fetch("/api/products");

        if (!response.ok) {
          throw new Error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }

        const data = await response.json();
        
        setProducts(data.products || []);
        setCategories(data.categories || []);
        
      } catch (err) {
        console.error("Error:", err);
        setError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ
  useEffect(() => {
    if (products.length > 0 && categories.length > 0) {
      const category = categories.find(cat => cat.id.toString() === params.id);
      
      if (category) {
        const filtered = products.filter(product => {
          const categoryName = category.name.toLowerCase();
          
          const searchFields = [
            product.category,
            product.group_name,
            product.kind_name,
            product.item_name,
          ]
            .filter(Boolean)
            .map(field => field?.toLowerCase());

          return searchFields.some(field => field?.includes(categoryName));
        });

        setCategoryProducts(filtered);
      } else {
        setCategoryProducts([]);
      }
    }
  }, [products, categories, params.id]);

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50">
        <Header />
        <div className="flex justify-center items-center h-64">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p className="mt-4 text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
          </div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gray-50">
        <Header />
        <div className="flex justify-center items-center h-64">
          <div className="text-center">
            <p className="text-red-600">{error}</p>
          </div>
        </div>
      </div>
    );
  }

  const category = categories.find(cat => cat.id.toString() === params.id);

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />
      
      <main className="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-6">
          {category?.name || `Ø§Ù„ØªØµÙ†ÙŠÙ ${params.id}`}
        </h1>
        
        <p className="text-gray-600 mb-8">
          Ø¹Ø±Ø¶ {categoryProducts.length} Ù…Ù†ØªØ¬ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ
        </p>

        {categoryProducts.length > 0 ? (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {categoryProducts.map((product) => (
              <ProductCard key={product.modelId} product={product} />
            ))}
          </div>
        ) : (
          <div className="text-center py-12">
            <div className="text-gray-400 text-6xl mb-4">ğŸ“¦</div>
            <h3 className="text-lg font-medium text-gray-900 mb-2">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª
            </h3>
            <p className="text-gray-600">
              {category 
                ? `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ ØªØµÙ†ÙŠÙ "${category.name}"`
                : "Ø§Ù„ØªØµÙ†ÙŠÙ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
              }
            </p>
          </div>
        )}
      </main>
    </div>
  );
}